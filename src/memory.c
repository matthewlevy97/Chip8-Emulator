#include "cpu.h"
#include "memory.h"

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>

static char fontset_buffer[] = {
    0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
    0x20, 0x60, 0x20, 0x20, 0x70, // 1
    0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
    0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
    0x90, 0x90, 0xF0, 0x10, 0x10, // 4
    0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
    0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
    0xF0, 0x10, 0x20, 0x40, 0x40, // 7
    0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
    0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
    0xF0, 0x90, 0xF0, 0x90, 0x90, // A
    0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
    0xF0, 0x80, 0x80, 0x80, 0xF0, // C
    0xE0, 0x90, 0x90, 0x90, 0xE0, // D
    0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
    0xF0, 0x80, 0xF0, 0x80, 0x80, // F
};

int memory_load_program(CHIP8_cpu *cpu, const char * filename) {
    int fd, program_size;
    
    if((fd = open(filename, O_RDONLY)) < 0) {
        fprintf(stderr, "Error opening %s\n", filename);
        exit(0);
    }
    
    program_size = read(fd, cpu->memory + 0x200, CHIP8_MEMORY_SIZE - 0x200);
    close(fd);
    
    // Copy fontset
    memcpy(cpu->memory + FONTSET_OFFSET, fontset_buffer, sizeof(fontset_buffer));
    
    return program_size;
}

char memory_read(CHIP8_cpu *cpu, short address) {
    return cpu->memory[address & CHIP8_MEMORY_SIZE];
}

void memory_write(CHIP8_cpu *cpu, short address, char value) {
    cpu->memory[address & CHIP8_MEMORY_SIZE] = value;
}
